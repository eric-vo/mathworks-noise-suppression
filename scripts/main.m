% main.m - Main execution script for denoising evaluation pipeline
% 
% Steps:
%   1. Generate noisy files using clean samples and noise sources
%   2. Apply pre-trained denoising model
%   3. Evaluate denoising performance using correlation metrics
% 
% Add noise to clean custom samples 
cleanOriginalDir = "data/test/gabrielSamples/clean8Khz";
noiseDir = "data/noise";
noisyOutputDir = "data/test/gabrielSamples/noisy8Khz";
%%
generateNoisyDir(cleanOriginalDir, noiseDir, noisyOutputDir, snr_dB = 5) %[output:37ec4a60]
%%
% Denoise noised custom samples
model = "models/denoiseNet_FineTuned_VBD.mat";
noisyInputDir = "data/test/gabrielSamples/noisy8Khz";
denoisedOutputDir = "data/test/gabrielSamples/output_wav";

denoisedAudioArray = denoiseSpeechDir(model, noisyInputDir, denoisedOutputDir);
%%
% Find the average correlation between the original clean audio and the denoised audio
[correlations, avgCorr] = calculateCorrelationDir(denoisedAudioArray, cleanOriginalDir, 5, 10); %[output:19445030]
disp("Correlations:") %[output:9c791468]
disp(correlations) %[output:333745ef]
fprintf('Average correlation: %.6f\n', avgCorr); %[output:674bdddf]
%%
% Denoise VBD Test Set
model = "models/denoiseNet_FineTuned_VBD.mat";
noisyInputDir = "data/test/datasetSamples/noisy_testset_wav";
denoisedOutputDir = "data/test/datasetSamples/output_wav";
cleanOriginalDir = "data/test/datasetSamples/clean_testset_wav";

denoisedAudioArray = denoiseSpeechDir(model, noisyInputDir, denoisedOutputDir, clear = 0); %[output:1e00662c]
%%
% Find the average correlation between the original clean audio and the denoised audio
[correlations, avgCorr] = calculateCorrelationDir(denoisedAudioArray, cleanOriginalDir);

disp("Correlations:")
disp(correlations)
fprintf('Average correlation: %.6f\n', avgCorr);

%[appendix]{"version":"1.0"}
%---
%[metadata:view]
%   data: {"layout":"inline","rightPanelPercent":30.4}
%---
%[output:37ec4a60]
%   data: {"dataType":"text","outputData":{"text":"Mixing 1.wav + birds_farm.wav at 5 dB SNR...\nMixing 1.wav + cafe.wav at 5 dB SNR...\nMixing 1.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 1.wav + pencils.wav at 5 dB SNR...\nMixing 1.wav + waves.wav at 5 dB SNR...\nMixing 10.wav + birds_farm.wav at 5 dB SNR...\nMixing 10.wav + cafe.wav at 5 dB SNR...\nMixing 10.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 10.wav + pencils.wav at 5 dB SNR...\nMixing 10.wav + waves.wav at 5 dB SNR...\nMixing 2.wav + birds_farm.wav at 5 dB SNR...\nMixing 2.wav + cafe.wav at 5 dB SNR...\nMixing 2.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 2.wav + pencils.wav at 5 dB SNR...\nMixing 2.wav + waves.wav at 5 dB SNR...\nMixing 3.wav + birds_farm.wav at 5 dB SNR...\nMixing 3.wav + cafe.wav at 5 dB SNR...\nMixing 3.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 3.wav + pencils.wav at 5 dB SNR...\nMixing 3.wav + waves.wav at 5 dB SNR...\nMixing 4.wav + birds_farm.wav at 5 dB SNR...\nMixing 4.wav + cafe.wav at 5 dB SNR...\nMixing 4.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 4.wav + pencils.wav at 5 dB SNR...\nMixing 4.wav + waves.wav at 5 dB SNR...\nMixing 5.wav + birds_farm.wav at 5 dB SNR...\nMixing 5.wav + cafe.wav at 5 dB SNR...\nMixing 5.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 5.wav + pencils.wav at 5 dB SNR...\nMixing 5.wav + waves.wav at 5 dB SNR...\nMixing 6.wav + birds_farm.wav at 5 dB SNR...\nMixing 6.wav + cafe.wav at 5 dB SNR...\nMixing 6.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 6.wav + pencils.wav at 5 dB SNR...\nMixing 6.wav + waves.wav at 5 dB SNR...\nMixing 7.wav + birds_farm.wav at 5 dB SNR...\nMixing 7.wav + cafe.wav at 5 dB SNR...\nMixing 7.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 7.wav + pencils.wav at 5 dB SNR...\nMixing 7.wav + waves.wav at 5 dB SNR...\nMixing 8.wav + birds_farm.wav at 5 dB SNR...\nMixing 8.wav + cafe.wav at 5 dB SNR...\nMixing 8.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 8.wav + pencils.wav at 5 dB SNR...\nMixing 8.wav + waves.wav at 5 dB SNR...\nMixing 9.wav + birds_farm.wav at 5 dB SNR...\nMixing 9.wav + cafe.wav at 5 dB SNR...\nMixing 9.wav + jet_city_birds.wav at 5 dB SNR...\nMixing 9.wav + pencils.wav at 5 dB SNR...\nMixing 9.wav + waves.wav at 5 dB SNR...\nAll files processed and saved.\n","truncated":false}}
%---
%[output:19445030]
%   data: {"dataType":"text","outputData":{"text":"Processing clean file 1.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.027317\nMSE: 0.000746\nSNR: 8.36 dB\nNRMSE: 0.382152\nPSNR: 22.39 dB\nMAE: 0.017553\nCorrelation: 0.926761\n\nProcessing clean file 1.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.024429\nMSE: 0.000597\nSNR: 9.33 dB\nNRMSE: 0.341751\nPSNR: 23.36 dB\nMAE: 0.017924\nCorrelation: 0.940214\n\nProcessing clean file 1.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.019062\nMSE: 0.000363\nSNR: 11.48 dB\nNRMSE: 0.266670\nPSNR: 25.51 dB\nMAE: 0.013880\nCorrelation: 0.964064\n\nProcessing clean file 1.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.023712\nMSE: 0.000562\nSNR: 9.58 dB\nNRMSE: 0.331718\nPSNR: 23.62 dB\nMAE: 0.012896\nCorrelation: 0.944836\n\nProcessing clean file 1.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.018564\nMSE: 0.000345\nSNR: 11.71 dB\nNRMSE: 0.259706\nPSNR: 25.74 dB\nMAE: 0.013249\nCorrelation: 0.967135\n\nProcessing clean file 2.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.020379\nMSE: 0.000415\nSNR: 7.52 dB\nNRMSE: 0.420918\nPSNR: 22.21 dB\nMAE: 0.013350\nCorrelation: 0.908128\n\nProcessing clean file 2.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.017842\nMSE: 0.000318\nSNR: 8.67 dB\nNRMSE: 0.368533\nPSNR: 23.36 dB\nMAE: 0.013391\nCorrelation: 0.930261\n\nProcessing clean file 2.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.014589\nMSE: 0.000213\nSNR: 10.42 dB\nNRMSE: 0.301337\nPSNR: 25.11 dB\nMAE: 0.010662\nCorrelation: 0.953521\n\nProcessing clean file 2.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.017578\nMSE: 0.000309\nSNR: 8.80 dB\nNRMSE: 0.363072\nPSNR: 23.49 dB\nMAE: 0.010057\nCorrelation: 0.932876\n\nProcessing clean file 2.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.013189\nMSE: 0.000174\nSNR: 11.30 dB\nNRMSE: 0.272423\nPSNR: 25.99 dB\nMAE: 0.009778\nCorrelation: 0.963369\n\nProcessing clean file 3.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.021547\nMSE: 0.000464\nSNR: 7.76 dB\nNRMSE: 0.409396\nPSNR: 21.50 dB\nMAE: 0.014804\nCorrelation: 0.913907\n\nProcessing clean file 3.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.019052\nMSE: 0.000363\nSNR: 8.83 dB\nNRMSE: 0.362002\nPSNR: 22.57 dB\nMAE: 0.014531\nCorrelation: 0.932450\n\nProcessing clean file 3.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.015344\nMSE: 0.000235\nSNR: 10.71 dB\nNRMSE: 0.291534\nPSNR: 24.45 dB\nMAE: 0.011655\nCorrelation: 0.956922\n\nProcessing clean file 3.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.019269\nMSE: 0.000371\nSNR: 8.73 dB\nNRMSE: 0.366116\nPSNR: 22.48 dB\nMAE: 0.011016\nCorrelation: 0.931703\n\nProcessing clean file 3.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.015619\nMSE: 0.000244\nSNR: 10.55 dB\nNRMSE: 0.296775\nPSNR: 24.30 dB\nMAE: 0.011804\nCorrelation: 0.956946\n\nProcessing clean file 4.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.039953\nMSE: 0.001596\nSNR: 8.77 dB\nNRMSE: 0.364258\nPSNR: 24.42 dB\nMAE: 0.026267\nCorrelation: 0.931566\n\nProcessing clean file 4.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.041081\nMSE: 0.001688\nSNR: 8.53 dB\nNRMSE: 0.374544\nPSNR: 24.18 dB\nMAE: 0.030541\nCorrelation: 0.928260\n\nProcessing clean file 4.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.031077\nMSE: 0.000966\nSNR: 10.95 dB\nNRMSE: 0.283339\nPSNR: 26.60 dB\nMAE: 0.022168\nCorrelation: 0.959373\n\nProcessing clean file 4.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.045955\nMSE: 0.002112\nSNR: 7.56 dB\nNRMSE: 0.418978\nPSNR: 23.20 dB\nMAE: 0.030105\nCorrelation: 0.937662\n\nProcessing clean file 4.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.027024\nMSE: 0.000730\nSNR: 12.17 dB\nNRMSE: 0.246383\nPSNR: 27.81 dB\nMAE: 0.019411\nCorrelation: 0.971243\n\nProcessing clean file 5.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.025498\nMSE: 0.000650\nSNR: 9.38 dB\nNRMSE: 0.339486\nPSNR: 22.62 dB\nMAE: 0.017299\nCorrelation: 0.941159\n\nProcessing clean file 5.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.027880\nMSE: 0.000777\nSNR: 8.61 dB\nNRMSE: 0.371207\nPSNR: 21.84 dB\nMAE: 0.020966\nCorrelation: 0.929516\n\nProcessing clean file 5.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.020616\nMSE: 0.000425\nSNR: 11.23 dB\nNRMSE: 0.274487\nPSNR: 24.46 dB\nMAE: 0.015044\nCorrelation: 0.961640\n\nProcessing clean file 5.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.026414\nMSE: 0.000698\nSNR: 9.08 dB\nNRMSE: 0.351682\nPSNR: 22.31 dB\nMAE: 0.014468\nCorrelation: 0.937331\n\nProcessing clean file 5.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.020527\nMSE: 0.000421\nSNR: 11.27 dB\nNRMSE: 0.273298\nPSNR: 24.50 dB\nMAE: 0.015362\nCorrelation: 0.963329\n\nProcessing clean file 6.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.028611\nMSE: 0.000819\nSNR: 8.07 dB\nNRMSE: 0.394918\nPSNR: 22.02 dB\nMAE: 0.019129\nCorrelation: 0.920047\n\nProcessing clean file 6.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.026136\nMSE: 0.000683\nSNR: 8.86 dB\nNRMSE: 0.360757\nPSNR: 22.80 dB\nMAE: 0.019705\nCorrelation: 0.933455\n\nProcessing clean file 6.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.020528\nMSE: 0.000421\nSNR: 10.95 dB\nNRMSE: 0.283357\nPSNR: 24.90 dB\nMAE: 0.015320\nCorrelation: 0.959186\n\nProcessing clean file 6.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.024806\nMSE: 0.000615\nSNR: 9.31 dB\nNRMSE: 0.342396\nPSNR: 23.26 dB\nMAE: 0.013755\nCorrelation: 0.940511\n\nProcessing clean file 6.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.019625\nMSE: 0.000385\nSNR: 11.34 dB\nNRMSE: 0.270893\nPSNR: 25.29 dB\nMAE: 0.014478\nCorrelation: 0.964429\n\nProcessing clean file 7.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.039602\nMSE: 0.001568\nSNR: 8.49 dB\nNRMSE: 0.376299\nPSNR: 23.49 dB\nMAE: 0.025324\nCorrelation: 0.927683\n\nProcessing clean file 7.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.038822\nMSE: 0.001507\nSNR: 8.66 dB\nNRMSE: 0.368895\nPSNR: 23.66 dB\nMAE: 0.028493\nCorrelation: 0.929938\n\nProcessing clean file 7.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.030363\nMSE: 0.000922\nSNR: 10.80 dB\nNRMSE: 0.288512\nPSNR: 25.80 dB\nMAE: 0.021930\nCorrelation: 0.957628\n\nProcessing clean file 7.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.042020\nMSE: 0.001766\nSNR: 7.97 dB\nNRMSE: 0.399278\nPSNR: 22.97 dB\nMAE: 0.026841\nCorrelation: 0.938845\n\nProcessing clean file 7.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.026924\nMSE: 0.000725\nSNR: 11.84 dB\nNRMSE: 0.255836\nPSNR: 26.84 dB\nMAE: 0.018768\nCorrelation: 0.968895\n\nProcessing clean file 8.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.025792\nMSE: 0.000665\nSNR: 9.85 dB\nNRMSE: 0.321898\nPSNR: 23.43 dB\nMAE: 0.017807\nCorrelation: 0.947009\n\nProcessing clean file 8.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.029856\nMSE: 0.000891\nSNR: 8.57 dB\nNRMSE: 0.372630\nPSNR: 22.16 dB\nMAE: 0.022600\nCorrelation: 0.929224\n\nProcessing clean file 8.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.021439\nMSE: 0.000460\nSNR: 11.45 dB\nNRMSE: 0.267580\nPSNR: 25.04 dB\nMAE: 0.016018\nCorrelation: 0.963599\n\nProcessing clean file 8.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.028162\nMSE: 0.000793\nSNR: 9.08 dB\nNRMSE: 0.351481\nPSNR: 22.67 dB\nMAE: 0.016455\nCorrelation: 0.936241\n\nProcessing clean file 8.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.021123\nMSE: 0.000446\nSNR: 11.58 dB\nNRMSE: 0.263624\nPSNR: 25.17 dB\nMAE: 0.016078\nCorrelation: 0.965917\n\nProcessing clean file 9.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.029621\nMSE: 0.000877\nSNR: 8.26 dB\nNRMSE: 0.386231\nPSNR: 22.02 dB\nMAE: 0.020015\nCorrelation: 0.923393\n\nProcessing clean file 9.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.028388\nMSE: 0.000806\nSNR: 8.63 dB\nNRMSE: 0.370159\nPSNR: 22.39 dB\nMAE: 0.021224\nCorrelation: 0.929026\n\nProcessing clean file 9.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.022710\nMSE: 0.000516\nSNR: 10.57 dB\nNRMSE: 0.296117\nPSNR: 24.32 dB\nMAE: 0.016971\nCorrelation: 0.955966\n\nProcessing clean file 9.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.026965\nMSE: 0.000727\nSNR: 9.08 dB\nNRMSE: 0.351600\nPSNR: 22.83 dB\nMAE: 0.015743\nCorrelation: 0.936512\n\nProcessing clean file 9.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.021697\nMSE: 0.000471\nSNR: 10.97 dB\nNRMSE: 0.282912\nPSNR: 24.72 dB\nMAE: 0.016260\nCorrelation: 0.963067\n\nProcessing clean file 10.wav, denoised version 1\n=== Audio Error Metrics ===\nRMSE: 0.049263\nMSE: 0.002427\nSNR: 8.07 dB\nNRMSE: 0.394717\nPSNR: 21.65 dB\nMAE: 0.032528\nCorrelation: 0.920636\n\nProcessing clean file 10.wav, denoised version 2\n=== Audio Error Metrics ===\nRMSE: 0.047957\nMSE: 0.002300\nSNR: 8.31 dB\nNRMSE: 0.384253\nPSNR: 21.89 dB\nMAE: 0.036172\nCorrelation: 0.923874\n\nProcessing clean file 10.wav, denoised version 3\n=== Audio Error Metrics ===\nRMSE: 0.035612\nMSE: 0.001268\nSNR: 10.89 dB\nNRMSE: 0.285337\nPSNR: 24.47 dB\nMAE: 0.026265\nCorrelation: 0.958644\n\nProcessing clean file 10.wav, denoised version 4\n=== Audio Error Metrics ===\nRMSE: 0.058873\nMSE: 0.003466\nSNR: 6.53 dB\nNRMSE: 0.471715\nPSNR: 20.11 dB\nMAE: 0.040960\nCorrelation: 0.939683\n\nProcessing clean file 10.wav, denoised version 5\n=== Audio Error Metrics ===\nRMSE: 0.032534\nMSE: 0.001058\nSNR: 11.68 dB\nNRMSE: 0.260678\nPSNR: 25.26 dB\nMAE: 0.023664\nCorrelation: 0.968770\n\nCorrelation values for clean file 1: 0.9268 0.9402 0.9641 0.9448 0.9671 \nCorrelation values for clean file 2: 0.9081 0.9303 0.9535 0.9329 0.9634 \nCorrelation values for clean file 3: 0.9139 0.9324 0.9569 0.9317 0.9569 \nCorrelation values for clean file 4: 0.9316 0.9283 0.9594 0.9377 0.9712 \nCorrelation values for clean file 5: 0.9412 0.9295 0.9616 0.9373 0.9633 \nCorrelation values for clean file 6: 0.9200 0.9335 0.9592 0.9405 0.9644 \nCorrelation values for clean file 7: 0.9277 0.9299 0.9576 0.9388 0.9689 \nCorrelation values for clean file 8: 0.9470 0.9292 0.9636 0.9362 0.9659 \nCorrelation values for clean file 9: 0.9234 0.9290 0.9560 0.9365 0.9631 \nCorrelation values for clean file 10: 0.9206 0.9239 0.9586 0.9397 0.9688 \nAverage correlation across all files: 0.9437\n","truncated":false}}
%---
%[output:9c791468]
%   data: {"dataType":"text","outputData":{"text":"Correlations:\n","truncated":false}}
%---
%[output:333745ef]
%   data: {"dataType":"text","outputData":{"text":"    0.9268    0.9402    0.9641    0.9448    0.9671\n    0.9081    0.9303    0.9535    0.9329    0.9634\n    0.9139    0.9324    0.9569    0.9317    0.9569\n    0.9316    0.9283    0.9594    0.9377    0.9712\n    0.9412    0.9295    0.9616    0.9373    0.9633\n    0.9200    0.9335    0.9592    0.9405    0.9644\n    0.9277    0.9299    0.9576    0.9388    0.9689\n    0.9470    0.9292    0.9636    0.9362    0.9659\n    0.9234    0.9290    0.9560    0.9365    0.9631\n    0.9206    0.9239    0.9586    0.9397    0.9688\n\n","truncated":false}}
%---
%[output:674bdddf]
%   data: {"dataType":"text","outputData":{"text":"Average correlation: 0.943727\n","truncated":false}}
%---
%[output:1e00662c]
%   data: {"dataType":"error","outputData":{"errorType":"runtime","text":"Error using <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('arrayfun')\" style=\"font-weight:bold\">arrayfun<\/a>\nNon-scalar in Uniform output, at index 1, output 1.\nSet 'UniformOutput' to false.\n\nError in <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('denoiseSpeechDir', 'C:\\Users\\Kailash\\Documents\\MATLAB\\MathWorks Internship\\mathworks-noise-suppression\\scripts\\denoiseSpeechDir.m', 20)\" style=\"font-weight:bold\">denoiseSpeechDir<\/a> (<a href=\"matlab: opentoline('C:\\Users\\Kailash\\Documents\\MATLAB\\MathWorks Internship\\mathworks-noise-suppression\\scripts\\denoiseSpeechDir.m',20,0)\">line 20<\/a>)\n    fileNums = arrayfun(@(f) sscanf(f.name, '%d'), fileList);\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"}}
%---
